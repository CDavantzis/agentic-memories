<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-4</epicId>
    <storyId>4-2-improve-worthiness-prompt-with-negative-cases</storyId>
    <title>Improve Worthiness Prompt with Negative Cases</title>
    <status>drafted</status>
    <generatedAt>2025-12-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-2-improve-worthiness-prompt-with-negative-cases.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>memory system</asA>
    <iWant>the worthiness check to reject obvious/redundant content</iWant>
    <soThat>low-value content is filtered early (before LLM extraction)</soThat>
    <tasks>
      <task id="1" status="pending">
        <name>Add "NOT Worthy" Section</name>
        <subtasks>
          <subtask>1.1 Open src/services/prompts.py</subtask>
          <subtask>1.2 Locate WORTHINESS_PROMPT variable (lines 1-23)</subtask>
          <subtask>1.3 Add "## NOT Worthy (Even if it seems like a preference)" section</subtask>
          <subtask>1.4 Add bullet: Generic desires everyone has (with examples)</subtask>
          <subtask>1.5 Add bullet: Quantitative facts about holdings</subtask>
          <subtask>1.6 Add bullet: Obvious implications of stated preferences</subtask>
          <subtask>1.7 Add bullet: Restatements of previous memories</subtask>
          <subtask>1.8 Add bullet: Meta-commentary about conversation</subtask>
        </subtasks>
      </task>
      <task id="2" status="pending">
        <name>Add "Ask Yourself" Decision Framework</name>
        <subtasks>
          <subtask>2.1 Add "## Ask Yourself" section after NOT Worthy section</subtask>
          <subtask>2.2 Add question 1: "Would this help personalize for THIS user vs. any user?"</subtask>
          <subtask>2.3 Add question 2: "Is this NOVEL information not already stored?"</subtask>
          <subtask>2.4 Add question 3: "Is this INSIGHT (why) rather than STATE (what)?"</subtask>
          <subtask>2.5 Add decision rule: "If any answer is NO, mark as NOT worthy"</subtask>
        </subtasks>
      </task>
      <task id="3" status="pending">
        <name>Test Negative Cases</name>
        <subtasks>
          <subtask>3.1 Create test function for worthiness check</subtask>
          <subtask>3.2 Test input: "I want to make money investing" - verify worthy: false</subtask>
          <subtask>3.3 Test input: "I have a portfolio" - verify worthy: false</subtask>
          <subtask>3.4 Test input: "Tell me about the stock market" - verify worthy: false</subtask>
          <subtask>3.5 Document rejection reasons in test output</subtask>
        </subtasks>
      </task>
      <task id="4" status="pending">
        <name>Test Positive Cases</name>
        <subtasks>
          <subtask>4.1 Test input: "I prefer value investing because it's lower risk" - verify worthy: true</subtask>
          <subtask>4.2 Test input: "I'm John, a 35-year-old engineer in NYC" - verify worthy: true</subtask>
          <subtask>4.3 Test input: "I'm bullish on AAPL due to services revenue growth" - verify worthy: true</subtask>
          <subtask>4.4 Test input: "I'm building a portfolio tracking app" - verify worthy: true</subtask>
          <subtask>4.5 Verify confidence scores are appropriate</subtask>
        </subtasks>
      </task>
      <task id="5" status="pending">
        <name>Integration Test</name>
        <subtasks>
          <subtask>5.1 Run full extraction pipeline with mixed worthy/unworthy content</subtask>
          <subtask>5.2 Verify worthiness check filters before extraction LLM call</subtask>
          <subtask>5.3 Check logs show proper rejection reasons</subtask>
          <subtask>5.4 Verify no false negatives (valid content incorrectly rejected)</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <description>Add "NOT Worthy" section to WORTHINESS_PROMPT containing: Generic desires, Quantitative facts about holdings, Obvious implications, Restatements, Meta-commentary</description>
      <verification>Section exists in WORTHINESS_PROMPT with all 5 categories</verification>
    </criterion>
    <criterion id="AC2">
      <description>Add "Ask Yourself" decision framework with 3 questions and decision rule</description>
      <verification>Section exists after NOT Worthy section with 3 questions and rule</verification>
    </criterion>
    <criterion id="AC3">
      <description>Test negative case: "User wants to make money" returns worthy: false</description>
      <verification>Run API test and verify response</verification>
    </criterion>
    <criterion id="AC4">
      <description>Test positive case: "User prefers X because Y" returns worthy: true</description>
      <verification>Run API test and verify response</verification>
    </criterion>
    <criterion id="AC5">
      <description>Existing worthy content still passes (regression): Profile info, Finance with insight, Projects</description>
      <verification>Regression tests pass</verification>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epic-extraction-quality.md" relevance="high">Epic definition with problem statement</doc>
      <doc path="docs/sprint-artifacts/4-2-improve-worthiness-prompt-with-negative-cases.md" relevance="high">Story file with detailed tasks</doc>
      <doc path="docs/sprint-artifacts/4-1-add-negative-examples-to-extraction-prompt.md" relevance="medium">Related story - alignment on terminology</doc>
    </docs>
    <code>
      <file path="src/services/prompts.py" relevance="critical" lines="1-23">
        <description>Contains WORTHINESS_PROMPT - the primary file to modify</description>
        <keySection name="WORTHINESS_PROMPT" startLine="1" endLine="23">
          Main worthiness prompt that needs NOT Worthy and Ask Yourself sections added
        </keySection>
      </file>
      <file path="src/services/graph_extraction.py" relevance="high" lines="19-31">
        <description>Contains node_worthiness that calls the WORTHINESS_PROMPT</description>
        <keyFunction name="node_worthiness" startLine="19" endLine="31">
          Calls _call_llm_json with WORTHINESS_PROMPT
        </keyFunction>
      </file>
    </code>
    <dependencies>
      <dependency name="openai" usage="LLM calls for worthiness check">Used via _call_llm_json</dependency>
      <dependency name="langgraph" usage="Graph-based extraction pipeline">StateGraph in graph_extraction.py</dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="placement">NOT Worthy section must be added before the .strip() call in WORTHINESS_PROMPT</constraint>
    <constraint type="alignment">Terminology must align with Story 4.1 EXTRACTION_PROMPT anti-patterns</constraint>
    <constraint type="regression">Existing worthy content (profiles, finance with insight, projects) must still pass</constraint>
    <constraint type="testing">Use API calls via curl for testing (not docker exec)</constraint>
  </constraints>

  <interfaces>
    <interface name="WORTHINESS_PROMPT">
      <type>String template</type>
      <location>src/services/prompts.py:1-23</location>
      <usage>Passed to LLM via _call_llm_json in node_worthiness function</usage>
      <output>JSON with worthy: boolean, confidence: number, tags: string[], reasons: string[]</output>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard>Run tests via curl API calls to /v1/store endpoint</standard>
      <standard>Negative cases should return 0 memories extracted</standard>
      <standard>Positive cases should return 1+ memories extracted</standard>
      <standard>Regression: existing valid extractions must continue working</standard>
    </standards>
    <locations>
      <location>Manual curl testing via API</location>
    </locations>
    <ideas>
      <testCase id="TC1" type="negative">
        <name>Truism Rejection</name>
        <input>"I want to make money investing"</input>
        <expectedOutput>worthy: false or 0 memories</expectedOutput>
      </testCase>
      <testCase id="TC2" type="negative">
        <name>Generic Portfolio Statement</name>
        <input>"I have a portfolio"</input>
        <expectedOutput>worthy: false or 0 memories</expectedOutput>
      </testCase>
      <testCase id="TC3" type="negative">
        <name>Meta-chatter</name>
        <input>"Tell me about the stock market"</input>
        <expectedOutput>worthy: false or 0 memories</expectedOutput>
      </testCase>
      <testCase id="TC4" type="positive">
        <name>Preference with Reason</name>
        <input>"I prefer value investing because it's lower risk"</input>
        <expectedOutput>worthy: true, 1+ memories</expectedOutput>
      </testCase>
      <testCase id="TC5" type="regression">
        <name>Profile Extraction</name>
        <input>"I'm John, a 35-year-old engineer in NYC"</input>
        <expectedOutput>worthy: true, profile memories extracted</expectedOutput>
      </testCase>
      <testCase id="TC6" type="regression">
        <name>Finance with Insight</name>
        <input>"I'm bullish on AAPL due to services revenue growth"</input>
        <expectedOutput>worthy: true, finance memory with insight</expectedOutput>
      </testCase>
    </ideas>
  </tests>

  <proposedChanges>
    <change id="1" file="src/services/prompts.py" type="addition">
      <description>Add "## NOT Worthy" and "## Ask Yourself" sections to WORTHINESS_PROMPT before .strip()</description>
      <insertionPoint>After line 22 (before .strip())</insertionPoint>
      <content><![CDATA[
## NOT Worthy (Even if it seems like a preference)

- Generic desires everyone has ("wants to make money", "wants success", "wants to be happy")
- Quantitative facts about holdings (portfolio tool tracks these: "owns X shares", "bought at $Y")
- Obvious implications of stated preferences (don't restate what's already clear)
- Restatements of previous memories (check existing before marking worthy)
- Meta-commentary about the conversation itself ("asked about stocks", "discussed portfolio")

## Ask Yourself

Before marking as worthy:
1. Would this help personalize responses for THIS user vs. any user?
2. Is this NOVEL information not already stored?
3. Is this INSIGHT (why) rather than STATE (what)?

If any answer is NO, mark as NOT worthy.
]]></content>
    </change>
  </proposedChanges>

  <relationshipToStory41>
    <note>Story 4.1 adds anti-patterns to EXTRACTION_PROMPT (filters DURING extraction)</note>
    <note>Story 4.2 adds negative cases to WORTHINESS_PROMPT (filters BEFORE extraction)</note>
    <note>These are complementary: worthiness is the first gate, extraction is the second</note>
    <note>Both should align on definitions of: Truisms, State data, Meta-chatter</note>
  </relationshipToStory41>
</story-context>
